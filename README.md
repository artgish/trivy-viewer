# Trivy Viewer

> Note. 90% of the code in this repository is vibe engineered with [claude-code](https://claude.com/product/claude-code)

A modern, web-based viewer for [Trivy](https://github.com/aquasecurity/trivy) security scan reports with multi-cloud storage support. Trivy Viewer provides an intuitive interface to visualize, filter, and analyze container vulnerability reports generated by Trivy.

## Features

- **Multi-Cloud Storage Support**: Seamlessly works with AWS S3, Google Cloud Storage, Azure Blob Storage, or local filesystem
- **Interactive Dashboard**: Clean, modern UI with real-time filtering and search capabilities
- **Vulnerability Analysis**: View detailed vulnerability information including CVE IDs, severity levels, affected packages, and remediation guidance
- **Severity-Based Filtering**: Filter vulnerabilities by severity (Critical, High, Medium, Low, Unknown)
- **File Management**: Browse, search, and archive scan reports directly from the web interface
- **Direct File Access**: Access specific reports via URL path (`/files/{filename}`)
- **Drag & Drop Upload**: Upload local Trivy JSON reports for instant analysis
- **Responsive Design**: Works seamlessly on desktop and mobile devices

## Prerequisites

- **Node.js**: Version 18 or higher
- **Storage Backend** (choose one):
  - AWS S3 bucket (requires AWS credentials)
  - Google Cloud Storage bucket (requires GCP credentials)
  - Azure Blob Storage container (requires Azure credentials)
  - Local filesystem directory

## Installation

### 1. Clone the Repository

```bash
git clone <repository-url>
cd trivy-viewer
```

### 2. Install Dependencies

```bash
npm install
```

### 3. Configure Environment Variables

Create a `.env` file in the project root (use `.env.example` as a template):

```bash
cp .env.example .env
```

Edit the `.env` file with your storage configuration:

```bash
# Required: Storage location
STORAGE_LOCATION=s3://your-bucket-name

# Optional: Storage prefix (subfolder within bucket/path)
STORAGE_PREFIX=trivy-reports

# Optional: Server port (default: 3000)
PORT=3000
```

See [Configuration](#configuration) section for detailed storage provider setup.

## Usage

### Starting the Server

**Development mode** (with auto-restart on file changes):

```bash
npm run dev
```

**Production mode**:

```bash
npm start
```

The server will start at `http://localhost:3000` (or the port specified in your `.env` file).

### Using the Web Interface

1. **Upload Local File**: Click "Upload Local File" or drag and drop a Trivy JSON report
2. **Browse Storage Files**: Click "Browse storage Files" to view reports from your configured storage backend
3. **Filter & Search**: Use severity filters and search box to find specific vulnerabilities
4. **Archive Reports**: Archive processed reports to keep your active storage organized

### Direct File Access

Access a specific report directly via URL:

```
http://localhost:3000/files/report-name.json
```

This will automatically load and display the specified report from your storage backend's active path.

## Configuration

### Storage Providers

The `STORAGE_LOCATION` environment variable determines which storage provider to use. The application automatically detects the provider based on the URI scheme.

#### AWS S3

**Environment Variables**:

```bash
STORAGE_LOCATION=s3://your-bucket-name
STORAGE_PREFIX=trivy-reports
AWS_REGION=us-east-1
AWS_ACCESS_KEY_ID=your-access-key-id
AWS_SECRET_ACCESS_KEY=your-secret-access-key
```

**Alternative**: Use IAM roles or AWS credential profiles instead of hardcoded keys.

**Storage Structure**:
```
s3://your-bucket-name/
└── trivy-reports/           # STORAGE_PREFIX
    ├── active/              # Active reports
    │   └── report1.json
    └── archived/            # Archived reports
        └── report2.json.2025-12-15T10:30:00.000Z
```

#### Google Cloud Storage

**Environment Variables**:

```bash
STORAGE_LOCATION=gs://your-bucket-name

STORAGE_PREFIX=trivy-reports
```

**Authentication**: The application uses [Application Default Credentials](https://cloud.google.com/docs/authentication/application-default-credentials). Set up authentication using one of these methods:

```bash
# Option 1: Service account key file
export GOOGLE_APPLICATION_CREDENTIALS="/path/to/service-account-key.json"

# Option 2: gcloud CLI (for local development)
gcloud auth application-default login
```

**Storage Structure**:
```
gs://your-bucket-name/
└── trivy-reports/           # STORAGE_PREFIX
    ├── active/              # Active reports
    │   └── report1.json
    └── archived/            # Archived reports
        └── report2.json.2025-12-15T10:30:00.000Z
```

#### Azure Blob Storage

**Environment Variables**:

```bash
STORAGE_LOCATION=azure://storageaccount/container-name
STORAGE_PREFIX=trivy-reports
```

**Authentication**: The application uses [DefaultAzureCredential](https://learn.microsoft.com/en-us/javascript/api/@azure/identity/defaultazurecredential), which supports multiple authentication methods:

- Environment variables (`AZURE_TENANT_ID`, `AZURE_CLIENT_ID`, `AZURE_CLIENT_SECRET`)
- Managed Identity (when running in Azure)
- Azure CLI credentials (for local development)

**Local Development Setup**:

```bash
# Login via Azure CLI
az login
```

**Storage Structure**:
```
https://storageaccount.blob.core.windows.net/container-name/
└── trivy-reports/           # STORAGE_PREFIX
    ├── active/              # Active reports
    │   └── report1.json
    └── archived/            # Archived reports
        └── report2.json.2025-12-15T10:30:00.000Z
```

#### Local Filesystem

**Environment Variables**:

```bash
STORAGE_LOCATION=/path/to/trivy/reports
STORAGE_PREFIX=
```

**Storage Structure**:
```
/path/to/trivy/reports/
├── active/                  # Active reports
│   └── report1.json
└── archived/                # Archived reports
    └── report2.json.2025-12-15T10:30:00.000Z
```

**Note**: Ensure the application has read/write permissions to the specified directory.

### Storage Directory Structure

All storage providers follow the same directory structure:

- **active/**: Contains current Trivy scan reports (`.json` files)
- **archived/**: Contains archived reports with ISO timestamp suffixes

When a report is archived, it's moved from `active/` to `archived/` with a timestamp appended to the filename (e.g., `report.json.2025-12-15T10:30:00.000Z`).

## API Endpoints

### GET /api/files

List JSON files from the active storage path.

**Query Parameters**:
- `limit` (optional): Maximum number of files to return (default: 1000, max: 1000)
- `continuationToken` (optional): Pagination token from previous response

**Response**:
```json
{
  "files": [
    {
      "key": "prefix/active/report.json",
      "name": "report.json",
      "size": 45678,
      "lastModified": "2025-12-15T10:30:00.000Z"
    }
  ],
  "nextContinuationToken": "token",
  "hasMore": true
}
```

### GET /api/files/:key

Retrieve a specific JSON file by key.

**Parameters**:
- `:key`: File path (can be just the filename or full path)

**Response**: JSON content of the Trivy report

**Errors**:
- `404`: File not found
- `500`: Server error

### POST /api/files/archive

Archive a file (move from active to archived path).

**Request Body**:
```json
{
  "key": "prefix/active/report.json"
}
```

**Response**:
```json
{
  "message": "File archived successfully",
  "originalKey": "prefix/active/report.json",
  "archivedKey": "prefix/archived/report.json.2025-12-15T10:30:00.000Z"
}
```

**Errors**:
- `400`: Invalid key or file not in active path
- `500`: Server error

### GET /api/health

Health check endpoint.

**Response**:
```json
{
  "status": "ok",
  "timestamp": "2025-12-15T10:30:00.000Z"
}
```

### GET /files/:filename

Web interface route that displays a specific file.

**Parameters**:
- `:filename`: Name of the file to load

This serves the main HTML interface, which automatically loads the specified file from storage.

## Docker Deployment

### Build the Image

```bash
docker build -t trivy-viewer:latest .
```

### Run with Local Storage

```bash
docker run -d \
  --name trivy-viewer \
  -p 3000:3000 \
  -v /path/to/reports:/data \
  -e STORAGE_LOCATION=/data \
  trivy-viewer:latest
```

### Run with S3 Storage

```bash
docker run -d \
  --name trivy-viewer \
  -p 3000:3000 \
  -e STORAGE_LOCATION=s3://your-bucket \
  -e STORAGE_PREFIX=trivy-reports \
  -e AWS_REGION=us-east-1 \
  -e AWS_ACCESS_KEY_ID=your-key \
  -e AWS_SECRET_ACCESS_KEY=your-secret \
  trivy-viewer:latest
```

### Run with Google Cloud Storage

```bash
docker run -d \
  --name trivy-viewer \
  -p 3000:3000 \
  -v /path/to/service-account.json:/app/gcp-key.json:ro \
  -e STORAGE_LOCATION=gs://your-bucket \
  -e STORAGE_PREFIX=trivy-reports \
  -e GOOGLE_APPLICATION_CREDENTIALS=/app/gcp-key.json \
  trivy-viewer:latest
```

### Run with Azure Blob Storage

```bash
docker run -d \
  --name trivy-viewer \
  -p 3000:3000 \
  -e STORAGE_LOCATION=azure://storageaccount/container \
  -e STORAGE_PREFIX=trivy-reports \
  -e AZURE_TENANT_ID=your-tenant-id \
  -e AZURE_CLIENT_ID=your-client-id \
  -e AZURE_CLIENT_SECRET=your-client-secret \
  trivy-viewer:latest
```

## Generating Trivy Reports

To generate compatible Trivy reports, use the following command:

```bash
# Scan a container image
trivy image --format json --output report.json alpine:latest

# Scan a filesystem
trivy fs --format json --output report.json /path/to/code

# Scan with specific severities
trivy image --format json --severity CRITICAL,HIGH --output report.json alpine:latest
```

Upload the generated `report.json` file to your storage backend's `active/` directory, or use the web interface to upload it directly.

## Development

### Project Structure

```
trivy-viewer/
├── src/
│   ├── server.js              # Express server and API routes
│   ├── providers/
│   │   ├── index.js           # Provider factory and type detection
│   │   ├── s3.js              # AWS S3 storage provider
│   │   ├── gcs.js             # Google Cloud Storage provider
│   │   ├── azure.js           # Azure Blob Storage provider
│   │   └── filesystem.js      # Local filesystem provider
│   └── public/
│       └── index.html         # Single-page web application
├── package.json
├── Dockerfile
└── .env.example
```

### Adding a New Storage Provider

1. Create a new provider class in `src/providers/`:
   ```javascript
   class CustomStorageProvider {
     constructor(location, prefix) {
       this.prefix = prefix;
       this.activePath = /* ... */;
       this.archivedPath = /* ... */;
     }

     async listFiles(subPath, limit, continuationToken) { /* ... */ }
     async getFile(key) { /* ... */ }
     async copyFile(sourceKey, destKey) { /* ... */ }
     async deleteFile(key) { /* ... */ }
   }
   ```

2. Register the provider in `src/providers/index.js`:
   ```javascript
   if (storageLocation.startsWith('custom://')) {
     const bucket = storageLocation.slice(9);
     return new CustomStorageProvider(bucket, storagePrefix);
   }
   ```

## Troubleshooting

### Common Issues

**Error: "STORAGE_LOCATION env var is required"**
- Ensure the `STORAGE_LOCATION` environment variable is set in your `.env` file

**Files not appearing in storage list**
- Verify that files are in the `active/` subdirectory within your storage location
- Ensure files have a `.json` extension
- Check storage provider credentials and permissions

**Cannot archive files**
- Ensure the storage provider has write and delete permissions
- Verify that the `archived/` directory exists or the provider can create it

## Security Considerations

- **Credentials**: Never commit credentials to version control. Use environment variables or credential files
- **IAM Roles**: When running in cloud environments (AWS EC2, GCP Compute Engine, Azure VMs), use IAM roles/managed identities instead of hardcoded credentials
- **Network Access**: Consider running behind a reverse proxy with authentication for production deployments
- **File Validation**: The application only processes `.json` files from the configured storage location

## License

MIT

## Contributing

Contributions are welcome! Please feel free to submit issues or pull requests.

## Acknowledgments

- Built for visualizing [Aqua Security Trivy](https://github.com/aquasecurity/trivy) scan results
- Uses Express.js for the backend API
- Cloud storage integration via official AWS, GCP, and Azure SDKs
